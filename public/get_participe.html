<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <title>Confirma√ß√£o de Presen√ßa - DETIN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
  <body class="bg-gray-100 text-gray-800 p-4">
    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6">
      <h1 class="text-2xl font-bold mb-6 text-center">
        Confirma√ß√£o de Participa√ß√£o - DETIN
      </h1>

      <!-- Carrossel -->
      <div class="mb-5 relative w-full overflow-hidden rounded-xl h-64">
        <div
          id="carousel"
          class="flex transition-transform duration-500 ease-in-out w-full h-full"
        >
          <img
            src="../imagem/foto_01.jpeg"
            class="w-full h-full object-cover flex-shrink-0"
          />
          <img
            src="../imagem/foto_02.jpeg"
            class="w-full h-full object-cover flex-shrink-0"
          />
          <img
            src="../imagem/foto_03.png"
            class="w-full h-full object-cover flex-shrink-0"
          />
        </div>
      </div>

      <script>
        const carousel = document.getElementById("carousel");
        const slides = carousel.children;
        const totalSlides = slides.length;
        let currentIndex = 0;

        function updateCarousel() {
          const slideWidth = slides[0].offsetWidth;
          carousel.style.transform = `translateX(-${
            currentIndex * slideWidth
          }px)`;
        }

        setInterval(() => {
          currentIndex = (currentIndex + 1) % totalSlides;
          updateCarousel();
        }, 3000);

        window.addEventListener("resize", updateCarousel);
      </script>

      <!-- Descri√ß√£o -->
      <p class="text-center text-gray-600 mb-2"><b>üéâ Comunicado ‚Äì Festa de Fim de Ano 2025 üéâ</b></p>
        <p class="text-center text-gray-600 mb-2"></p>  
        <p class="text-center text-gray-600 mb-2">Prezados(as) colegas,</p>
        <p class="text-center text-gray-600 mb-4">
        √â com grande entusiasmo que anunciamos nosso Jantar de Fim de Ano, que ser√° realizado no dia 27 de dezembro (s√°bado), no Vidas Buffet.
        Abaixo, seguem as informa√ß√µes importantes sobre o evento:</p>
        <p class="text-center text-gray-600 mb-2">
        üí∞ Valores de participa√ß√£o:</p>
        <p class="text-center text-gray-600 mb-2">* Servidores: R$ 200,00</p>
        <p class="text-center text-gray-600 mb-2">* Estagi√°rios: R$ 120,00</p>
        <p class="text-center text-gray-600 mb-2">* Acompanhantes: R$ 200,00</p>
        <p class="text-center text-gray-600 mb-2">* Crian√ßas:</p>
        <p class="text-center text-gray-600 mb-2">‚ó¶ De 04 a 10 anos: R$ 100,00</p>
        <p class="text-center text-gray-600 mb-2">‚ó¶ De 11 a 14 anos: R$ 120,00</p>  
        <p class="text-center text-gray-600 mb-2">Os valores poder√£o ser parcelados em at√© 8 vezes, com in√≠cio dos pagamentos previsto para abril/maio. O valor total deve estar quitado at√©, no m√°ximo, novembro.</p>
        <p class="text-center text-gray-600 mb-2">üì¢ Aten√ß√£o: Solicitamos que todos os servidores manifestem seu interesse em participar o quanto antes, para que possamos organizar o evento da melhor forma poss√≠vel.</p>
        <p class="text-center text-gray-600 mb-4"></p>

      <!-- Formul√°rio -->
      <form class="space-y-4" id="confirmacaoForm">
        <div>
          <label class="block mb-1 font-semibold">Setor:</label>
          <select id="setor" class="w-full border rounded px-3 py-2" required>
            <option value="">Selecione um setor</option>
            <!-- Preenchido dinamicamente -->
          </select>
        </div>

        <div>
          <label class="block mb-1 font-semibold">Nome:</label>
          <select
            id="colaborador"
            class="w-full border rounded px-3 py-2"
            required
          >
            <option value="">Selecione o nome</option>
            <!-- Preenchido ap√≥s sele√ß√£o do setor -->
          </select>
        </div>

        <div>
          <label class="block mb-1 font-semibold">Voc√™ ir√° participar?</label>
          <select
            id="participar"
            class="w-full border rounded px-3 py-2"
            required
          >
            <option value="">Selecione</option>
            <option value="sim">Sim</option>
            <option value="nao">N√£o</option>
          </select>
        </div>

        <div id="acompanhantesWrapper" class="hidden">
          <label class="block mb-1 font-semibold"
            >Quantidade de acompanhantes:</label
          >
          <input
            type="number"
            id="acompanhantes"
            min="0"
            max="10"
            class="w-full border rounded px-3 py-2"
            value="0"
          />
        </div>

        <button
          type="submit"
          class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
        >
          Confirmar
        </button>
      </form>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const setorSelect = document.getElementById("setor");
        const colaboradorSelect = document.getElementById("colaborador");
        const participarSelect = document.getElementById("participar");
        const acompanhantesWrapper = document.getElementById("acompanhantesWrapper");
        const confirmacaoForm = document.getElementById("confirmacaoForm");

        // Fun√ß√£o para carregar setores
        function carregarSetores() {
          fetch("../backend/get_setores.php")
            .then((response) => {
              if (!response.ok) {
                throw new Error("Erro ao carregar setores");
              }
              return response.json();
            })
            .then((setores) => {
              setores.forEach((setor) => {
                const option = document.createElement("option");
                option.value = setor;
                option.textContent = setor;
                setorSelect.appendChild(option);
              });
            })
            .catch((error) => console.error("Erro:", error));
        }

        // Fun√ß√£o para carregar colaboradores com base no setor selecionado
        function carregarColaboradores(setorId) {
          colaboradorSelect.innerHTML =
            '<option value="">Selecione o nome</option>'; // Resetar op√ß√µes

          if (!setorId) return; // N√£o carregar se nenhum setor for selecionado

          fetch(`../backend/get_colaboradores.php?setor=${encodeURIComponent(setorId)}`)
            .then((response) => {
              if (!response.ok) {
                throw new Error("Erro ao carregar colaboradores");
              }
              return response.json();
            })
            .then((colaboradores) => {
              console.log("Colaboradores carregados:", colaboradores); // Log para depura√ß√£o

              if (colaboradores.error) {
                console.error("Erro:", colaboradores.error);
                return;
              }

              // Preencher o dropdown com os colaboradores
              colaboradores.forEach((colaborador) => {
                const option = document.createElement("option");
                option.value = colaborador.id;
                option.textContent = colaborador.nome;
                colaboradorSelect.appendChild(option);
              });
            })
            .catch((error) => console.error("Erro ao carregar colaboradores:", error));
        }

        // Evento para carregar colaboradores ao selecionar um setor
        setorSelect.addEventListener("change", () => {
          const setorId = setorSelect.value;
          console.log("Setor selecionado:", setorId); // Log para depura√ß√£o
          carregarColaboradores(setorId);
        });

        // Evento para mostrar/ocultar o campo de acompanhantes
        participarSelect.addEventListener("change", () => {
          const participarValue = participarSelect.value;

          if (participarValue === "sim") {
            acompanhantesWrapper.classList.remove("hidden"); // Mostrar o campo
          } else {
            acompanhantesWrapper.classList.add("hidden"); // Ocultar o campo
          }
        });

        // Evento de envio do formul√°rio
        confirmacaoForm.addEventListener("submit", async (event) => {
          event.preventDefault(); // Impedir o envio padr√£o do formul√°rio

          // Validar campos
          const setor = setorSelect.value;
          const colaborador = colaboradorSelect.value;
          const participar = participarSelect.value;
          const acompanhantes = document.getElementById("acompanhantes").value;

          if (!setor || !colaborador || !participar) {
            Swal.fire({
              icon: "error",
              title: "Oops...",
              text: "Por favor, preencha todos os campos obrigat√≥rios.",
            });
            return;
          }

          // Enviar os dados para o backend
          try {
            const response = await fetch("../backend/confirmar.php", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                colaborador_id: colaborador,
                vai_participar: participar,
                acompanhantes: acompanhantes,
              }),
            });

            const result = await response.json();

            if (result.status === "ok") {
              Swal.fire({
                icon: "success",
                title: "Sucesso!",
                text: "Sua confirma√ß√£o foi enviada com sucesso!",
              });

              // Limpar o formul√°rio
              confirmacaoForm.reset();
              setorSelect.innerHTML = '<option value="">Selecione um setor</option>';
              colaboradorSelect.innerHTML = '<option value="">Selecione o nome</option>';
              acompanhantesWrapper.classList.add("hidden");
            } else {
              throw new Error(result.message || "Erro ao gravar os dados.");
            }
          } catch (error) {
            Swal.fire({
              icon: "error",
              title: "Erro!",
              text: error.message || "Ocorreu um erro ao enviar sua confirma√ß√£o. Tente novamente.",
            });
          }
        });

        // Carregar setores ao carregar a p√°gina
        carregarSetores();
      });
    </script>
  </body>
</html>